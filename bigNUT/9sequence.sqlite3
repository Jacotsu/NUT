/*
  Custom script to add next meal automatically.  Invoke it thus:
	.read sequence.sqlite3
  This is something NUTsqlite can't do, complicated meal ordering with
  automatic changes to personal options!
*/

begin;

UPDATE mealfoods
SET    nutr_no = NULL;UPDATE options
SET    defanal_am =
       (
              SELECT
                     CASE
                            WHEN defanal_am >= 45 THEN 45
                            WHEN o.currentmeal = lastmeal THEN defanal_am + 1
                            ELSE defanal_am
                     END
              FROM   options o,
                     am_analysis_header);WITH newcm
     (
          meal_id
     )
     AS
     (
          WITH cm1
               (
                    base,
                    meal
               )
               AS
               (
                    WITH cm
                         (
                              base,
                              meal
                         )
                         AS
                         (
                                SELECT currentmeal / 100,
                                       currentmeal % 100
                                FROM   options
                         )
                  SELECT
                         CASE
                                WHEN meal = 3 THEN Date(Substr(base, 1, 4)
                                              || '-'
                                              || Substr(base, 5, 2)
                                              || '-'
                                              || Substr(base, 7, 2), '+1 day')
                                ELSE Substr(base, 1, 4)
                                              || '-'
                                              || Substr(base, 5, 2)
                                              || '-'
                                              || Substr(base, 7, 2)
                         END,
                         CASE
                                WHEN meal = 3 THEN 1
                                ELSE meal + 1
                         END
                  FROM   cm
               )
        SELECT Cast( Substr(base, 1, 4)
                      || Substr(base, 6, 2)
                      || Substr(base, 9, 2) AS INT) * 100 + meal
        FROM   cm1
     )
UPDATE options
SET    currentmeal =
       (
              SELECT meal_id
              FROM   newcm);DROP VIEWIF EXISTS z_mn;CREATE temp VIEW z_mn AS
WITH meal
     (
          m,
          mod2
     )
     AS
     (
            SELECT options.currentmeal % 100,
                   maxmeal %             2
            FROM   options,
                   am_analysis_header
     )SELECT
       CASE
              WHEN mod2 = 0 THEN
                     CASE
                            WHEN m = 1 THEN 'Z Breakfast'
                            WHEN m = 2 THEN 'Z Dinner'
                            ELSE 'Z Supper'
                     END
              ELSE
                     CASE
                            WHEN m = 1 THEN 'Z Breakfast'
                            WHEN m = 2 THEN 'Z Dinner'
                            ELSE 'Z Supper'
                     END
       END AS mn,
       m
FROM   meal;INSERT INTO currentmeal
SELECT ndb_no,
       gm_wgt,
       nutrdesc
FROM   theusual
WHERE  meal_name =
       (
              SELECT mn
              FROM   z_mn);DROP VIEW z_mn;COMMIT;

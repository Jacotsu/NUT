/*
 redestribute oil/fat foods in keto meal
*/

INSERT INTO currentmeal
VALUES      (4047,
             NULL,
             NULL);

INSERT INTO currentmeal
VALUES      (4584,
             NULL,
             NULL);

INSERT INTO currentmeal
SELECT ndb_no,
       CASE
         WHEN ndb_no = 4584 THEN 0.9
         ELSE 0.0
       END * gm_wgt * third / fat,
       NULL
FROM   (WITH first
             AS (SELECT m.ndb_no,
                        gm_wgt,
                        gm_wgt * nutr_val / 100.0 AS fat
                 FROM   mealfoods m
                        join nut_data n
                          ON m.ndb_no = n.ndb_no
                             AND n.nutr_no = 204
                 WHERE  meal_id = (SELECT currentmeal
                                   FROM   options)
                        AND m.ndb_no IN ( 1145, 4047, 4584 ))
        SELECT *,
               (SELECT SUM(fat) / 3.0
                FROM   first) AS third
         FROM   first)
WHERE  ndb_no IN ( 4047, 4584 );

DELETE FROM mealfoods
WHERE  gm_wgt = 0.0
       AND ndb_no IN ( 4047, 4584 )
       AND meal_id = (SELECT currentmeal
                      FROM   options);
